<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-container">
                <a href="/" class="logo">ðŸŒ¸ Japanese Vocab Test</a>
                <ul class="nav-menu">
                    <li><a href="/quiz/list">Quizzes</a></li>
                    <li><a href="/test/create" class="btn-create">Create Test</a></li>
                </ul>
            </div>
        </nav>
    </header>
    <main>
        <div class="container">
            <h1>Create New Test</h1>
            <% if (typeof error !== 'undefined') { %>
                <div class="error-message"><%= error %></div>
            <% } %>

            <form id="createTestForm" class="create-test-form">
                <div class="form-group">
                    <label for="level">Select Level:</label>
                    <select id="level" name="level" required>
                        <option value="n5">N5</option>
                        <option value="n4" selected>N4</option>
                        <option value="n3">N3</option>
                        <option value="n2">N2</option>
                        <option value="n1">N1</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Selection Mode:</label>
                    <div>
                        <label><input type="radio" name="mode" value="chapter" checked> By Chapter</label>
                        <label style="margin-left:1rem;"><input type="radio" name="mode" value="range"> By Entry Range</label>
                    </div>
                </div>

                <div id="chapterControls">
                    <div class="form-group">
                        <label for="chapter">Chapters (numbers and ranges supported):</label>
                        <input type="text" id="chapter" name="chapter" placeholder="e.g., 1,3-5,8" aria-describedby="chapterHelp">
                        <small id="chapterHelp">Enter individual chapters or ranges separated by commas. Examples: <code>1</code>, <code>1,2,5</code>, <code>3-7</code>, <code>1,3-5,8</code>.</small>
                    </div>
                    <div class="form-group">
                        <label for="numQuestions">Number of Questions (optional):</label>
                        <input type="number" id="numQuestions" name="numQuestions" min="1" placeholder="e.g., 20">
                    </div>
                    <div class="form-group" style="margin-top:0.5rem;">
                        <label>Quick chapter helpers:</label>
                        <div>
                            <button type="button" class="btn" data-ch="1">1</button>
                            <button type="button" class="btn" data-ch="2">2</button>
                            <button type="button" class="btn" data-ch="3">3</button>
                            <button type="button" class="btn" data-ch="4">4</button>
                            <button type="button" class="btn" data-ch="5">5</button>
                            <button type="button" id="clearChapters" class="btn">Clear</button>
                        </div>
                        <small>Click to append a chapter to the input above.</small>
                    </div>
                </div>

                <div id="rangeControls" style="display:none;">
                    <div class="form-group">
                        <label>Entry ID Range (start - end):</label>
                        <div style="display:flex; gap:0.5rem; align-items:center;">
                            <input type="number" id="rangeStart" name="rangeStart" min="1" placeholder="start">
                            <span style="font-weight:bold;">â€”</span>
                            <input type="number" id="rangeEnd" name="rangeEnd" min="1" placeholder="end">
                        </div>
                        <small>Provide start and end entry IDs (order does not matter; start> end will be normalized).</small>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Create Test</button>
                </div>
            </form>

            <div id="createTestMessage" style="margin-top:1rem;"></div>
        </div>
    </main>
    <footer>
        <p>&copy; 2024 Japanese Vocabulary Quiz. For educational purposes.</p>
    </footer>

    <script>
    // Improved client-side behavior: toggle controls, enhanced parsing for chapters (supports ranges like 3-7),
    // separate numeric start/end inputs for range mode, quick chapter helper buttons, and better validation/messages.
    (function() {
        const form = document.getElementById('createTestForm');
        const modeRadios = document.getElementsByName('mode');
        const chapterControls = document.getElementById('chapterControls');
        const rangeControls = document.getElementById('rangeControls');
        const messageEl = document.getElementById('createTestMessage');
        const chapterInput = document.getElementById('chapter');
        const quickButtons = Array.from(document.querySelectorAll('#chapterControls button[data-ch]'));
        const clearBtn = document.getElementById('clearChapters');

        function updateMode() {
            const mode = Array.from(modeRadios).find(r => r.checked).value;
            if (mode === 'chapter') {
                chapterControls.style.display = '';
                rangeControls.style.display = 'none';
            } else {
                chapterControls.style.display = 'none';
                rangeControls.style.display = '';
            }
        }

        Array.from(modeRadios).forEach(r => r.addEventListener('change', updateMode));
        updateMode();

        // Quick chapter buttons append number to input (avoid duplicates)
        quickButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const val = btn.getAttribute('data-ch');
                let cur = (chapterInput.value || '').trim();
                if (!cur) {
                    chapterInput.value = val;
                    return;
                }
                // add with comma only if not present (allow ranges though)
                const parts = cur.split(',').map(s => s.trim()).filter(Boolean);
                if (!parts.includes(val)) {
                    parts.push(val);
                    chapterInput.value = parts.join(',');
                }
            });
        });
        clearBtn && clearBtn.addEventListener('click', () => {
            chapterInput.value = '';
        });

        // Parse chapters string like "1,3-5,8" into sorted unique number array
        function parseChaptersString(raw) {
            if (!raw) return [];
            const parts = raw.split(',').map(s => s.trim()).filter(Boolean);
            const set = new Set();
            parts.forEach(p => {
                if (/^\d+$/.test(p)) {
                    set.add(Number(p));
                    return;
                }
                const m = p.match(/^(\d+)\s*-\s*(\d+)$/);
                if (m) {
                    let a = Number(m[1]), b = Number(m[2]);
                    if (Number.isNaN(a) || Number.isNaN(b)) return;
                    const start = Math.min(a, b), end = Math.max(a, b);
                    for (let i = start; i <= end; i++) set.add(i);
                }
            });
            return Array.from(set).sort((a,b) => a-b);
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            messageEl.textContent = '';

            const formData = new FormData(form);
            const payload = {
                level: formData.get('level'),
                mode: formData.get('mode'),
                chapters: null,
                range: null,
                numQuestions: formData.get('numQuestions') ? parseInt(formData.get('numQuestions')) : null
            };

            if (payload.mode === 'chapter') {
                const raw = formData.get('chapter') || '';
                const chapters = parseChaptersString(raw);
                if (chapters.length === 0 && !payload.numQuestions) {
                    messageEl.textContent = 'Please specify at least one chapter (e.g., 1 or 1,3-5) or a number of questions.';
                    return;
                }
                payload.chapters = chapters.length ? chapters : null;
            } else {
                // read numeric start/end inputs
                const startRaw = document.getElementById('rangeStart').value;
                const endRaw = document.getElementById('rangeEnd').value;
                const start = startRaw ? parseInt(startRaw, 10) : NaN;
                const end = endRaw ? parseInt(endRaw, 10) : NaN;
                if (Number.isNaN(start) || Number.isNaN(end)) {
                    messageEl.textContent = 'Please enter both start and end entry IDs for the range.';
                    return;
                }
                // normalize order
                payload.range = { start: Math.min(start,end), end: Math.max(start,end) };
            }

            try {
                messageEl.textContent = 'Creating test...';
                const resp = await fetch('/test/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!resp.ok) {
                    const errText = await resp.text();
                    messageEl.textContent = 'Failed to create test: ' + (errText || resp.statusText);
                    return;
                }
                const data = await resp.json();
                if (data && data.redirect) {
                    window.location.href = data.redirect;
                    return;
                } else if (data && data.id) {
                    window.location.href = '/test/' + data.id;
                    return;
                } else {
                    messageEl.textContent = 'Test created. Open /test/<id> to start.';
                }
            } catch (err) {
                console.error(err);
                messageEl.textContent = 'Error creating test. See console for details.';
            }
        });
    })();
    </script>
</body>
</html>
